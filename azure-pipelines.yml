pool:
  vmImage: 'ubuntu-latest'

variables:
  phpVersion: 8

resources:
  repositories:
    - repository: Shoutz0r
      type: github
      endpoint: github.com_xorinzor
      name: Shoutz0r/app

stages:
  - stage: unitTest
    jobs:
      - job: 'PHPUnit_Shoutz0rApp'
        displayName: 'Run PHPUnit for Shoutz0r-app'
        steps:
          - checkout: self
            persistCredentials: true
            clean: true

          - script: |
              cd ./Shoutz0r-app
              cp .env.template .env
            displayName: 'Environment Setup'

          - task: DockerCompose@0
            displayName: 'Start Containers in background'
            inputs:
              action: Run a Docker Compose command
              dockerComposeFile: docker-compose.yml
              additionalDockerComposeFiles: docker-compose.test.yml
              projectName: shoutzor
              dockerComposeCommand: up -d mysql redis

          - task: DockerCompose@0
            displayName: 'Install Shoutzor via composer'
            inputs:
              action: Run a Docker Compose command
              dockerComposeFile: docker-compose.yml
              additionalDockerComposeFiles: docker-compose.test.yml
              projectName: shoutzor
              dockerComposeCommand: run app composer install-shoutzor-dev

          - script: |
              cp .env .env.testing
            displayName: 'Create testing .env file'

          - task: DockerCompose@0
            displayName: 'Rebuild config cache'
            inputs:
              action: Run a Docker Compose command
              dockerComposeFile: docker-compose.yml
              additionalDockerComposeFiles: docker-compose.test.yml
              projectName: shoutzor
              dockerComposeCommand: run app php /code/artisan config:cache

          - task: DockerCompose@0
            displayName: 'Run PHPUnit'
            inputs:
              action: Run a Docker Compose command
              dockerComposeFile: docker-compose.yml
              additionalDockerComposeFiles: docker-compose.test.yml
              projectName: shoutzor
              dockerComposeCommand: run phpunit
